---
title: "BIOCLIM"
author: "Irene Extremera Serrano"
date: "9/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, warning = FALSE, error = FALSE, message = FALSE, comment = " ")
```

````{r, warning=FALSE, message=FALSE, echo= FALSE}

library(sp) #Tabajar con objetos de tipo espacial
library(rgdal) #Es necesaria para la librería sdmpredictors
library(carData)
library(car)
library(nlme)
library(gstat)
library(sf)
library(spData)
library(spdep)
library(lattice)
library(survival)
library(Formula)
library(ggplot2) #Para gráficos de las predicciones
library(Hmisc)
library(raster) #Para poder trabajar con objetos tipo raster
library(leaflet)
library(GGally)
library(maptools)
library(corrplot)
library(rgeos)
library(maptools) #Cargar mapas
library(dismo) #Para poder trabajar con BIOCLIM y MAXENT
library(sdmpredictors) #Para descargarme las variables ambientales
library(PresenceAbsence)
library(rJava)
library(randomForest)
library(INLA) #Para trabajar con INLA
library(Matrix)
library(parallel)
library(foreach)
library(dotCall64)
library(grid)
library(spam)
library(fields)
library(randomForest) #Para realizar Random Fores
library(gbm) #Para realizar vosted regression tree
library(TeachingDemos)
library(raster)
library(stars)
library(mgcv)
```


```{r, echo= FALSE}

# Directorio de trabajo

setwd("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Rmd")

# Mapa del mundo
data(wrld_simpl) 

#Presencias
data <- read.csv('C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/Anchoas_Aqua_atln.csv',TRUE,",")
data <- data[,-1] #Le quito al primera que es una columna de índices
colnames(data) <- c('Lon','Lat') #Le doy nombre a las columnas

#Predictores modelo
cuatro_pred <- (list.files("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Predictores/atl/Seleccionadas", full.names=T, pattern=".tif")) #Cargo bathy que lo he metido en una carpeta aparte
predictors <- stack(cuatro_pred)
names(predictors) <- c("bathy","odismean","salinity","tempmean")
predictors3 <- scale(predictors)

# Ausencias (Con todos los predictores pues es así como se han creado para meterlas al sdmdata_modelos)
files<-(list.files("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Predictores/atl", full.names=T, pattern=".tif"))#change directory
predictores <- stack(files)
names(predictores) <- c("bathy","chlomean","ppmean","odismean","salinity","tempmean")
predictors2 <- scale(predictores) #Los escalo
set.seed(141592) 
backgr <- randomPoints(predictors2, 1000) 

# Base de datos sin RAC.
sdmdata <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/sdmdata_atln_modelos.csv")
sdmdata <- sdmdata[,-1]

# Para comprobar que todo está en orden
plot(wrld_simpl,xlim=c(-20,35),ylim=c(43,70))
points(sdmdata[,6],sdmdata[,7])

# Modelo
bc.model <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/bc.model.rds")

# Predictiva
predict_presence_bc_bioclim<-readRDS( "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/Predicciones_BIOCLIM_Atl.ascii")

# Coeficientes
coef_bc_model <-  read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/coeficientes_BIOCLIM.csv")
cosites_bc_model <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/coeficientes_BIOCLIM_todos.csv")
cosites_bc_model<- cosites_bc_model[,c(-1)]

```

###########################
##### --- BIOCLIM --- #####
###########################

Primero comenzaré con el modelo mas sencillo, bioclim del paquete dismo.

```{r}

# Hago el modelo de BIOCLIM

bc.model <- bioclim(x = predictors3, p = data)
# bc.model

# Guardo el modelo
# saveRDS(bc.model, "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/bc.model.rds") #Guardo el modelo BIOCLIM

```

Dentro del objeto no hay residuos por lo que no puedo hacer ningún tipo de análisis de los residuos. Por lo que paso directamente a la realización y representación de la predictiva. (trabajando en ello para sacarlos)

```{r}

# Predictiva de presencias
ext <-extent(-20,35,43,70) #Para Atlántico Norte

predict_presence_bc_bioclim <- predict(object = bc.model,
                                   x = predictors3,
                                   ext = ext)

# La pinto
ggplot() +
  geom_raster(data = raster::as.data.frame(predict_presence_bc_bioclim , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='') +
  guides(fill = guide_legend(label.position = "left", label.hjust = 1))

# La guardo
# saveRDS(predict_presence_bc_bioclim, "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/Predicciones_BIOCLIM_Atl.ascii")

```

En el mapa predictivo se puede ver que  en el Mar del Norte está la probabilidad mas alta de presencia, mientras que en la parte de costa Oeste de Gran Bretaña y Francia hay una probabilidad de presencia es ligeramente mas baja. Este valor va disminuyendo progresivamente a medida que se aleja de la zona.

A continuación valoro la calidad predictiva del modelo mediante la media de diez validaciones cruzadas.

```{r}

# FUNCIÓN DEFINITIVA DEFINITIVÍSIMA MILENARIA XTREM para BIOCLIM.
# Esta función sirve para hacer una cross validation y obtener así los distintos índices que me interesan.

fddmx <- function(coordenadas, predictores,background){

      group <- kfold(coordenadas, 5)

      pres_train <- coordenadas[group != 1, ] #Las que no sean 1
      pres_test <- coordenadas[group == 1, ] #Las que sean 1
      
      bc <- bioclim(predictores, pres_train)

      group <- kfold(background, 5) #Hago 5 grupos de esos puntos
      backg_train <- background[group != 1, ]
      backg_test <- background[group == 1, ]
      
      eval.modesta <- evaluate(pres_test, backg_test, bc, predictores)
      
      auc_model <- eval.modesta@auc #auc
      
      cor_model <- eval.modesta@cor #cor
      
      kappa_model <- mean(eval.modesta@kappa) #Kappa

      sensibility_model <- mean(eval.modesta@TPR/(eval.modesta@TPR+eval.modesta@FNR)) #Sensibilidad
      
      specificity_modelo <- mean(eval.modesta@TNR/(eval.modesta@FPR+eval.modesta@TNR)) #Especificidad
      
      TSS_model <- mean(eval.modesta@TPR+eval.modesta@TNR-1) #TSS
      
      return(c(auc_model,cor_model,kappa_model,sensibility_model,specificity_modelo,TSS_model))
}

# Hago una matriz para guardar los valores de los coeficientes de las diez iteraciones que me devuelva la función 
cosites_bc_model <- matrix(ncol=6,nrow=10) 
      
# Genereo un bucle for de 10 iteraciones que me devuelva 10 valores diferentes de los 6 coeficientes.
for (i in 1:10) { cosites_bc_model[i,] <- fddmx(data,predictors3,backgr)}

# Le doy nombre a las columnas para saber qué coeficientes hay dentro
colnames(cosites_bc_model) <- c('AUC','COR','Kappa','Sensitivity','Specificity','TSS')

# Hago la media por columnas que es lo que me interesa y lo guardo
coef_bc_model <- apply(cosites_bc_model, 2, mean)
write.csv(coef_bc_model,'C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/coeficientes_BIOCLIM_media.csv')#Guardo los coeficientes 
write.csv(cosites_bc_model,'C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/coeficientes_BIOCLIM_todos.csv')#Guardo los coeficientes sin hacer la media

```

A PARTIR DE AQUÍ NO SÉ CÓMO ABORDARLO

```{r}
###### AUTOCORRELACIÓN ESPACIAL #####

# SACAR LOS RESIDUOS
### Paso de raster a data frame
pi<- raster::as.data.frame(predict_presence_bc_bioclim, xy = TRUE)
### Quito NAs
pi <- na.omit(pi)
str(pi)

# Redondeo porque si no lo hago no hay ninguna coincidencia
pi2<-round(pi,digits = 2)
sdmdata_round<-round(sdmdata,digits = 2)

# Miro cuáles coinciden 
x<- round(sdmdata_round[,6],digits = 2)
y<- round(sdmdata_round[,7],digits = 2)

length((which(pi2[,1]==x))*0) #coinciden 105 celdas
length((which(pi2[,2]==y))*0) #coinciden 159 celdas
length((which(pi2[,2]==y & pi2[,1]==x))*0) #Solo coinciden 2
```

```{r}
# Redondeo porque si no lo hago no hay ninguna coincidencia
pi3<-round(pi,digits = 3)
sdmdata_round<-round(sdmdata,digits = 3)

# Miro cuáles coinciden 
x<- round(sdmdata_round[,6],digits = 3)
y<- round(sdmdata_round[,7],digits = 3)

length((which(pi3[,1]==x))*0) #coinciden 105 celdas
length((which(pi3[,2]==y))*0) #coinciden 159 celdas
length((which(pi3[,2]==y & pi3[,1]==x))*0) #Solo coinciden 2
```

```{r}
#Sin redondear
length((which(pi[,1]==sdmdata[,6]))*0) #Sin redondear coinciden menos, 31
length((which(pi[,2]==sdmdata[,7]))*0) #48
length((which(pi[,2]==sdmdata[,7] & pi[,1]==sdmdata[,6]))*0) #Ninguno

```

```{r}
### AUTOCORRELACIÓN ESPACIAL ###
```

FALTARÍA:
- Sacar los residuos
- Calcular el índice de Moran
- Incluir en BIOCLIM la componente espacial de alguna manera (RAC?)
- Predicción
- CV
- Volver a mirar el índice de Moran
