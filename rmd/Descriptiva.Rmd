---
title: "Descriptiva"
author: "Irene Extremera Serrano"
date: "9/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, warning = FALSE, error = FALSE, message = FALSE, comment = " ")
```

````{r, warning=FALSE, message=FALSE, echo= FALSE}

library(sp) #Tabajar con objetos de tipo espacial
library(rgdal) #Es necesaria para la librería sdmpredictors
library(carData)
library(car)
library(nlme)
library(gstat)
library(sf)
library(spData)
library(spdep)
library(lattice)
library(survival)
library(Formula)
library(ggplot2) #Para gráficos de las predicciones
library(Hmisc)
library(raster) #Para poder trabajar con objetos tipo raster
library(leaflet)
library(GGally)
library(maptools)
library(corrplot)
library(rgeos)
library(maptools) #Cargar mapas
library(dismo) #Para poder trabajar con BIOCLIM y MAXENT
library(sdmpredictors) #Para descargarme las variables ambientales
library(PresenceAbsence)
library(rJava)
library(randomForest)
library(INLA) #Para trabajar con INLA
library(Matrix)
library(parallel)
library(foreach)
library(dotCall64)
library(grid)
library(spam)
library(fields)
library(randomForest) #Para realizar Random Fores
library(gbm) #Para realizar vosted regression tree
library(TeachingDemos)
library(raster)
library(stars)
library(mgcv)
```

#################################################
########    CARGAR LAS BASES DE DATOS    ########
#################################################

```{r, echo= FALSE}

# Directorio de trabajo

setwd("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Rmd")

# Mapa del mundo

data(wrld_simpl) 

#Presencias
data <- read.csv('C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/Anchoas_Aqua_atln.csv',TRUE,",")
data <- data[,-1] #Le quito al primera que es una columna de índices
colnames(data) <- c('Lon','Lat') #Le doy nombre a las columnas

#Realizo un plot para cerciorarme que todo está en orden 

plot(wrld_simpl, xlim= c(-20,35),ylim=c(43,70), axes=TRUE,col="light yellow", main='Presencias Anchoa')
points(data$Lon, data$Lat, col="blue", pch=20, cex=0.75)
points(data$Lon, data$Lat, col="pink", cex=0.75)

```

```{r, echo= FALSE}

# Predictores

files<-(list.files("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Predictores/atl", full.names=T, pattern=".tif"))#change directory
predictors <- stack(files)
names(predictors) <- c("bathy","chlomean","ppmean","odismean","salinity","tempmean")
plot(predictors) #Los pinto

predictors2 <- scale(predictors) #Los escalo

```

El sistema de referencia es el de coordenadas cartográficas y la resolución es de 0.0833º.

#############################################################
##### --- Presencias, Pseudoausencias & Otras cosas --- #####
#############################################################

```{r,echo= FALSE}

set.seed(141592) 
backgr <- randomPoints(predictors2, 1000) 

# Base de datos con los valores de las variables ambientales para cada presencia
sdmdata <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/sdmdata_atln.csv") #Todas las variables escaladas
sdmdata<- sdmdata[,c(-1,-2)]

sdmdata_nos <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/sdmdata_sin_escalar.csv") #Sin las variables escaladas
sdmdata_nos<- sdmdata_nos[,c(-1)]

#Pintado
plot(wrld_simpl, xlim= c(-10,40),ylim=c(36,75), axes=TRUE,col="light yellow")
points(sdmdata$x, sdmdata$y, col="pink", pch=20, cex=0.75)

```


#############################################################
################## ----- Descriptiva ----- ##################
#############################################################

Una vez obtenida la base datos a punto comienza la descriptiva.

```{r}

# Miro la correlación entre variables para identificar qué variables o no incluir.
# La correlación se empieza a plantear el no introducir la variable partir de 0.7.
# Hacer modelos con correlación y sin ella para ver cómo ajustan y ver cómo se explica (opcional)

matrix<-rcorr(as.matrix(sdmdata[,c(3:8)]), type = "pearson")

# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
  mat <- as.matrix(mat)
  n <- ncol(mat)
  p.mat<- matrix(NA, n, n)
  diag(p.mat) <- 0
  for (i in 1:(n - 1)) {
    for (j in (i + 1):n) {
      tmp <- cor.test(mat[, i], mat[, j], ...)
      p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
    }
  }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

corrplot(matrix$r, type="lower", tl.col = "black",method="number",
         p.mat = matrix$P, sig.level = 0.05)

```

Se puede observar que las correlaciones entre algunas de las variables son bastante altas:

- Chlomean y odismean con un 0.89, bastante alta y positiva.

- ppmean tiene una correlación negativa alta con salinidad -0.81 y tempmean -0.88.

A si a primera vista diría que las variables mas indicadas para entrar en el modelo serían: bathy, odismean, salinity y tempmean. 

A continuación realizo un ggpairs para ver qué tipo de relación hay entre las covariables escaladas y sin escalar.

```{r, echo=FALSE}

# Escaladas

par(mfrow=c(2,1))
attach(sdmdata)
G1<-ggplot(sdmdata, aes(bathy,chlomean) ) +
  geom_point()
G1

G2<-ggplot(sdmdata, aes(bathy,ppmean) ) +
  geom_point()
G2

G3<-ggplot(sdmdata, aes(bathy,salinity) ) +
  geom_point()
G3

G4<-ggplot(sdmdata, aes(bathy,odismean) ) +
  geom_point()
G4


G5<-ggplot(sdmdata, aes(bathy,tempmean) ) +
  geom_point()
G5


G6<-ggplot(sdmdata, aes(ppmean,chlomean) ) +
  geom_point()
G6

G7<-ggplot(sdmdata, aes(ppmean,odismean) ) +
  geom_point()
G7

G8<-ggplot(sdmdata, aes(ppmean,tempmean) ) +
  geom_point()
G8

G9<-ggplot(sdmdata, aes(ppmean,salinity) ) +
  geom_point()
G9

G10<-ggplot(sdmdata, aes(salinity,chlomean) ) +
  geom_point()
G10

G11<-ggplot(sdmdata, aes(salinity,tempmean) ) +
  geom_point()
G11

G12<-ggplot(sdmdata, aes(salinity,odismean) ) +
  geom_point()
G12

G13<-ggplot(sdmdata, aes(odismean,tempmean) ) +
  geom_point()
G13

G14<-ggplot(sdmdata, aes(odismean,chlomean) ) +
  geom_point()
G14

G15<-ggplot(sdmdata, aes(tempmean,chlomean) ) +
  geom_point()
G15

```

Se observa que la forma que tienen de relacionarse las variables entre ellas es bastante extraña en algunos casos. Por ello se valora a continuación realizar estos mismos gráficos con las variables ambientales sin escalar.

```{r, echo=FALSE}

# Escaladas

par(mfrow=c(2,1))
attach(sdmdata_nos)
G1<-ggplot(sdmdata_nos, aes(bathy,chlomean) ) +
  geom_point()
G1

G2<-ggplot(sdmdata_nos, aes(bathy,ppmean) ) +
  geom_point()
G2

G3<-ggplot(sdmdata_nos, aes(bathy,salinity) ) +
  geom_point()
G3

G4<-ggplot(sdmdata_nos, aes(bathy,odismean) ) +
  geom_point()
G4


G5<-ggplot(sdmdata_nos, aes(bathy,tempmean) ) +
  geom_point()
G5


G6<-ggplot(sdmdata_nos, aes(ppmean,chlomean) ) +
  geom_point()
G6

G7<-ggplot(sdmdata_nos, aes(ppmean,odismean) ) +
  geom_point()
G7

G8<-ggplot(sdmdata_nos, aes(ppmean,tempmean) ) +
  geom_point()
G8

G9<-ggplot(sdmdata_nos, aes(ppmean,salinity) ) +
  geom_point()
G9

G10<-ggplot(sdmdata_nos, aes(salinity,chlomean) ) +
  geom_point()
G10

G11<-ggplot(sdmdata_nos, aes(salinity,tempmean) ) +
  geom_point()
G11

G12<-ggplot(sdmdata_nos, aes(salinity,odismean) ) +
  geom_point()
G12

G13<-ggplot(sdmdata_nos, aes(odismean,tempmean) ) +
  geom_point()
G13

G14<-ggplot(sdmdata_nos, aes(odismean,chlomean) ) +
  geom_point()
G14

G15<-ggplot(sdmdata_nos, aes(tempmean,chlomean) ) +
  geom_point()
G15

```

Al comparar las gráficas en las que se relacionan las variables escaladas y no se comprueba que efectivamente entre ellas tienen una relación un poco extraña. 

Estas relaciones entre las covariables sirve de aliciente para pensar que uno de los modelos a realizar sea un modelo aditivo generalizado (GAM).
Además, cabe mencionar que la variable respuesta se distribuye como una binomial por lo que otro de los modelos a plantear será un modelo lineal generalizado (GLM).

En la linea de selección de variables, a continuación se mirará la multicolinealidad entre ellas mediante el VIF (factor de inflación de la varianza). Para ello se partirá de todas las variables y posteriormente se irán eliminando una a una las que tengan un mayor valor hasta que el grupo quede con valores de VIF menores a 3.

```{r}

# Compruebo si hay o no multicolinealidad entre variables
# El objetivo es quedarse con un conjunto de variables con un VIF menor a 5 y 3.

source("HighstatLib.r") #Función ya hecha
# corvif(sdmdata[,c(2:7)]) #Solo la hago para las que no son covaraibles
# View(sdmdata)
corvif(sdmdata[,c(2,5,6,7)]) #He ido quitando una a una las que tenían un GVIF mas alto, ppmean y chlmean

```

Las variables con las que me quedaré finalmente han sido: batimetría, oxígeno disuelto, temperatura media y salinidad. 



#########################################################
########### --- Comparación de modelos --- ##############
#########################################################

#Criterios de calidad frecuentista

```{r}
cosites_bc_model <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/coeficientes_BIOCLIM_todos.csv")
cosites_bc_model<- cosites_bc_model[,c(-1)]

cosites_maxent_model <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/MAXENT/coeficientes_MAXENT_atln_todos.csv")
cosites_maxent_model<-cosites_maxent_model[,-1]

cosites_brt <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/coeficientes_brt_todos.csv")
cosites_brt<-cosites_brt[,-1]

cosites_brt_rac <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/coeficientes_brt_rac_todos.csv")
cosites_brt_rac<-cosites_brt_rac[,-1]

cosites_rf_model <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/coeficientes_rf_todos.csv")
cosites_rf_model<-cosites_rf_model[,-1]

cosites_rf_rac <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/coeficientes_rf_rac_todos.csv")
cosites_rf_rac<-cosites_rf_rac[,-1]

cosites_glm <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/coeficientes_glmfrec_todas.csv")
cosites_glm <-cosites_glm[,-1]

cosites_glm_rac <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/coeficientes_glmrac_todas.csv")
cosites_glm_rac<-cosites_glm_rac[,-1]

cosites_gam <- read.csv('C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/coeficientes_gam_todas.csv')
cosites_gam <-cosites_gam[,-1]

cosites_gam_rac <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/coeficientes_gam_rac_todos.csv")
cosites_gam_rac<-cosites_gam_rac[,-1]

cosites_gam_bi <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/coeficientes_gam_bi_todos.csv")
cosites_gam_bi<-cosites_gam_bi[,-1]

cosas <- matrix(ncol=6,nrow=10,c(cosites_bc_model[,1],cosites_maxent_model[,1],cosites_brt[,1],cosites_rf_model[,1],cosites_glm[,1],cosites_gam[,1]))
colnames(cosas)<- c("BIOCLIM","MAXENT","BRT","RF","GLM","GAM")
nombres<-  c("AUC","COR","KAPPA","SENSITIVITY","SPECIFICIT","TSS")

for(i in 1:6){boxplot(cosites_bc_model[,i],cosites_maxent_model[,i],cosites_brt[,i],cosites_brt_rac[,i],cosites_rf_model[,i],cosites_rf_rac[,i],cosites_glm[,i],cosites_glm_rac[,i],cosites_gam[,i],cosites_gam_rac[,i],cosites_gam_bi[,i], col=c("pink","brown","dark green","green","grey","white","dark blue","blue","yellow","orange","red"),ylab=nombres[i],names=c("BIC","MXT","BRT","BT R","RF","RF R","GL","GL R","GA","GA R","GA B"))}


```
¿Qué modelos son mejores para qué cosas?
¿Cuál es el mejor modelo de cada grupo?

# Criterios de calidad INLA

```{r}
# INLA

coef_inla_sp<-read.csv('C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM INLA/coeficientes_glm_inla_todos_sp.csv')
coef_inla_sp<-coef_inla_sp[,-1]

coef_inla_nosp<-read.csv('C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM INLA/coeficientes_glm_inla_todos.csv')
coef_inla_nosp<-coef_inla_nosp[,-1]
summary(coef_inla_nosp)
summary(coef_inla_sp)

nombres<- c("CPO","WAIC","PO","DIC")
tipos <- labels("Sin Ep","Con Ep")
for(i in 1:4){boxplot(coef_inla_nosp[,i],coef_inla_sp[,i], col=c("red","yellow","blue","pink"),ylab=nombres[i],names=c("Sin EP","EP"))}

```

Explicar los resultados
Ventajas y desventajas con respecto a los modelos frecuentistas

# Deviance Explicada

```{r}
# BIOCLIM y MAXENT no tienen 

# BRT 
brt1 <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/brt_model.rds")
devexpl <- ((brt1$self.statistics$null-brt1$self.statistics$resid)/brt1$self.statistics$null)*100
devexpl #% de deviance explicada por el modelo

# BRT RAC
brt_rac <-readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/brt_rac.rds")
devexpl_rac <- ((brt_rac$self.statistics$null-brt_rac$self.statistics$resid)/brt_rac$self.statistics$null)*100
devexpl_rac #% de deviance explicada por el modelo

# RF
rf1 <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/RF_model.rds")
rf1 #46.16% de varianza explicada


# RF RAC
rf_rac <-readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/RF_model_rac.rds")
rf_rac #86.17% varianza explicada

# GLM
glm1 <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/GLM_model.rds")
devexp_glm <- ((glm1$null.deviance-glm1$deviance)/glm1$null.deviance)*100
devexp_glm

# GLM RAC
glm_rac <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/GLM_model_rac.rds")
devexp_glm_rac <- ((glm_rac$null.deviance-glm_rac$deviance)/glm_rac$null.deviance)*100
devexp_glm_rac

# GAM
gam1 <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/gam_model.rds")
devexp_gam_ <- ((gam1$null.deviance-gam1$deviance)/gam1$null.deviance)*100
devexp_gam_

# GAM BI
gam_bis <<- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/gam_bi_model.rds")
devexp_gam_bis <- ((gam_bis$null.deviance-gam_bis$deviance)/gam_bis$null.deviance)*100
devexp_gam_bis

#GAM RAC
gam_rac <-readRDS( "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/gam_rac.rds")
devexp_gam_rac <- ((gam_rac$null.deviance-gam_rac$deviance)/gam_rac$null.deviance)*100
devexp_gam_rac

# tabla <- matrix(ncol=2,nrow=11)
# tabla <- matrix(c(0,0,0,0,0,devexpl,0,devexpl_rac,46.16,0,86.17,0,0,devexp_glm,0,devexp_glm_rac,0,devexp_gam_,0,devexp_gam_bis,0,devexp_gam_rac),ncol=2,nrow=11)
# dev <- c(0,0,0,0,46.16,86.17,0,0,0,0,0,0,0,devexpl,devexpl_rac,0,0,devexp_glm,devexp_glm_rac,devexp_gam_,devexp_gam_bis,devexp_gam_rac)
# tabla <- matrix(dev,ncol=2,nrow=11)
# rownames(tabla)<- c("BIOCLIM","MAXENT","BRT","BRT RAC","RF","RF RAC","GLM","GLM RAC","GAM","GAM BIV","GAM RAC")
# colnames(tabla)<- c("% Varianza", "% Deviance")
tabla <- read.csv("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/tabla.csv")
tabla
# write.csv(tabla,"C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/Datos/tabla.csv")

```

El efecto espacial en todos los modelos produce un incremento de la deviance explicada. Parece ser que BRT con efecto espacial como RAC es el que explica mas % deviance seguido de GAM RAC, a continuación le sigue GLM RAC y RF RAC.

# Mapas:
## Predictiva sin RAC

```{r}

# Bioclim
predict_presence_bc_bioclim<-readRDS( "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/BIOCLIM/Predicciones_BIOCLIM_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(predict_presence_bc_bioclim , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='') +
  guides(fill = guide_legend(label.position = "left", label.hjust = 1))

# Maxent
predict_presence_maxent_model <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/MAXENT/Predicciones_MAXENT_alt.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(predict_presence_maxent_model , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')


# RF
pred_rf <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/Predicciones_RF_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(pred_rf , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

# BRT
pbrt <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/Predicciones_brt_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(pbrt , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

# GLM
predm1 <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/Predicciones_glm_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(predm1 , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

# GAM
pred_gam <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/Predicciones_gam_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(pred_gam , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

```

## Predictiva con RAC

```{r}

# Bioclim

# Maxent

# RF
pred_rf_rac <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/Predicciones_RF_rac_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(pred_rf_rac , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')


# BRT
pbrt_RAC <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/RF y BRT/Predicciones_brt_RAC_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(pbrt_RAC , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

# GLM
predm_glm_rac <- readRDS("C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GLM frecuentista/Predicciones_glm_rac_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(predm_glm_rac , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

# GAM
predm_gam_rac <- readRDS( "C:/Users/Irene/Source/Repositorios/TFM-Irene-Extremera/GAM/Predicciones_gam_rac_Atl.ascii")
ggplot() +
  geom_raster(data = raster::as.data.frame(predm_gam_rac , xy = TRUE) , aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  labs( x = "", y = "")+theme_minimal()+
  scale_color_brewer(palette = 'YlGnBu')+ labs(fill='')

```


